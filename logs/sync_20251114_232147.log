**********************
Начало записи сценария Windows PowerShell
Время начала: 20251114232147
Имя пользователя: BERS\artae
Запуск от имени пользователя: BERS\artae
Имя конфигурации: 
Компьютер: BERS (Microsoft Windows NT 10.0.26200.0)
Ведущее приложение: C:\WINDOWS\System32\WindowsPowerShell\v1.0\powershell.exe
ИД процесса: 26456
PSVersion: 5.1.26100.7019
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.26100.7019
BuildVersion: 10.0.26100.7019
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
Транскрибирование запущено, выходной файл logs\sync_20251114_232147.log
PS D:\GM\tools\2_Landmarking_v1.0> # 2) Обновляемся с GitHub на всякий случай
PS D:\GM\tools\2_Landmarking_v1.0> git fetch origin

PS D:\GM\tools\2_Landmarking_v1.0> git pull origin main
error: cannot pull with rebase: You have unstaged changes.
error: Please commit or stash them.
PS D:\GM\tools\2_Landmarking_v1.0> # 3) Создаём / обновляем scripts\init_structure.py (общая инициализация модуля)
PS D:\GM\tools\2_Landmarking_v1.0> $initPath = "scripts\init_structure.py"
PS D:\GM\tools\2_Landmarking_v1.0> $initContent = @'
from pathlib import Path

def get_root() -> Path:
    """Return repository root (two levels up from scripts/)."""
    return Path(__file__).resolve().parent.parent


def ensure_dirs(root: Path) -> None:
    """Create base folders required by the module."""
    # All paths are relative to repo root, no absolute paths.
    (root / "status").mkdir(parents=True, exist_ok=True)
    (root / "models").mkdir(parents=True, exist_ok=True)
    (root / "models" / "current").mkdir(parents=True, exist_ok=True)
    (root / "models" / "history").mkdir(parents=True, exist_ok=True)
    (root / "config").mkdir(parents=True, exist_ok=True)
    (root / "logs").mkdir(parents=True, exist_ok=True)
    (root / "datasets").mkdir(parents=True, exist_ok=True)


def ensure_hrnet_config(root: Path) -> None:
    """Create default config/hrnet_config.yaml if missing."""
    cfg_dir = root / "config"
    cfg_dir.mkdir(parents=True, exist_ok=True)
    cfg_path = cfg_dir / "hrnet_config.yaml"

    if cfg_path.exists():
        print(f"[INFO] Config already exists: {cfg_path}")
        return

    text = """model_type: "hrnet_w32"
input_size: 256        # 0 = do not resize (see resize_mode)
resize_mode: "resize"  # "resize" or "original"
keep_aspect_ratio: true
batch_size: 8
learning_rate: 0.0005
max_epochs: 100
train_val_split: 0.9
flip_augmentation: true
rotation_augmentation_deg: 15
scale_augmentation: 0.3
weight_decay: 0.0001
"""
    cfg_path.write_text(text, encoding="utf-8")
    print(f"[INFO] Created default config: {cfg_path}")


def ensure_localities_status(root: Path) -> None:
    """Create empty status/localities_status.csv with header if missing."""
    status_dir = root / "status"
    status_dir.mkdir(parents=True, exist_ok=True)
    status_path = status_dir / "localities_status.csv"

    if status_path.exists():
        print(f"[INFO] Status file already exists: {status_path}")
        return

    header = "locality,status,auto_quality,last_model_run,last_update,n_images,n_labeled\n"
    status_path.write_text(header, encoding="utf-8")
    print(f"[INFO] Created empty status file: {status_path}")


def main() -> None:
    root = get_root()
    print(f"[INFO] Landmarking root: {root}")
    ensure_dirs(root)
    ensure_hrnet_config(root)
    ensure_localities_status(root)


if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print("[ERR] init_structure.py failed:", e)
        raise SystemExit(1)
'@
PS D:\GM\tools\2_Landmarking_v1.0> $initContent | Set-Content -Path $initPath -Encoding UTF8
PS D:\GM\tools\2_Landmarking_v1.0> # 4) Переписываем 1_ANNOTATOR.bat, добавляя вызов init_structure.py и rebuild_localities_status.py
PS D:\GM\tools\2_Landmarking_v1.0> $annotContent = @'
@echo off
setlocal EnableExtensions EnableDelayedExpansion
chcp 65001 >nul

rem ---- Paths ----
set "HERE=%~dp0"
for %%I in ("%HERE%\..\..") do set "ROOT=%%~fI"
set "TOOL_DIR=%ROOT%\tools\2_Landmarking_v1.0"
set "PHOTOS_DIR=%ROOT%\photos"
set "LOG_DIR=%TOOL_DIR%\logs"
if not exist "%LOG_DIR%" mkdir "%LOG_DIR%" >nul 2>&1

rem ---- Localities base picker (Windows dialog) ----
powershell -NoProfile -ExecutionPolicy Bypass -File "%TOOL_DIR%\scripts\choose_localities.ps1" -Silent
if errorlevel 1 (
    echo [WARN] Localities base picker failed or was cancelled.>>"%LOG_DIR%\annotator_last.log"
    echo [WARN] Localities base picker failed or was cancelled. Using existing "%PHOTOS_DIR%".
)

rem ---- Resolve PHOTOS_DIR from cfg\last_base.txt, if present ----
set "CFG_DIR=%TOOL_DIR%\cfg"
set "LAST_BASE=%CFG_DIR%\last_base.txt"
if exist "%LAST_BASE%" (
    set /p PHOTOS_DIR=<"%LAST_BASE%"
)
if not defined PHOTOS_DIR (
    set "PHOTOS_DIR=%ROOT%\photos"
)

rem ---- Python resolver ----
set "PY=%TOOL_DIR%\.venv_lm\Scripts\python.exe"
if not exist "%PY%" (
    where.exe py >nul 2>&1 && (set "PY=py -3")
)
if /I "%PY%"=="py -3" (
    py -3 -c "import sys" >nul 2>&1 || set "PY="
)
if not defined PY (
    where.exe python >nul 2>&1 && (set "PY=python")
)
if not defined PY (
    echo [ERR] Landmarking environment not found.>>"%LOG_DIR%\annotator_last.log"
    echo [ERR] Landmarking environment not found.
    echo Run 0_INSTALL_ENV.ps1.
    pause
    exit /b 1
)

title == GM Landmarking: Points Annotator v1.0 ==
echo == GM Landmarking: Points Annotator v1.0 ==

if not exist "%PHOTOS_DIR%" (
    echo [ERR] Photos dir not found: %PHOTOS_DIR%
    pause
    exit /b 1
)

rem ---- Init structure + localities registry ----
%PY% "%TOOL_DIR%\scripts\init_structure.py"
if errorlevel 1 (
    echo [ERR] init_structure.py failed. See logs for details.>>"%LOG_DIR%\annotator_last.log"
    echo [ERR] init_structure.py failed. See logs for details.
    pause
    exit /b 1
)

%PY% "%TOOL_DIR%\scripts\rebuild_localities_status.py"
if errorlevel 1 (
    echo [ERR] rebuild_localities_status.py failed.>>"%LOG_DIR%\annotator_last.log"
    echo [ERR] rebuild_localities_status.py failed.
    pause
    exit /b 1
)

rem ---- Menu ----
echo.
%PY% "%TOOL_DIR%\scripts\menu_list.py" --print --root "%ROOT%"
set /p CH=
if /I "!CH!"=="Q" goto :EOF

set "TMP_SEL=%TEMP%\gm_sel_%RANDOM%.txt"
%PY% "%TOOL_DIR%\scripts\menu_list.py" --pick !CH! --root "%ROOT%" 1> "!TMP_SEL!" 2> "%LOG_DIR%\menu_pick_last.err"
if exist "!TMP_SEL!" (
    set /p SEL_LOC=<"!TMP_SEL!"
    del /q "!TMP_SEL!" 2>nul
)

if not defined SEL_LOC (
    echo [ERR] Invalid selection.
    echo See "%LOG_DIR%\menu_pick_last.err"
    pause
    exit /b 2
)

set "PNG_DIR=%PHOTOS_DIR%\!SEL_LOC!\png"
if not exist "!PNG_DIR!" (
    echo [ERR] Locality path not found: !PNG_DIR!
    pause
    exit /b 2
)

rem ---- Find first PNG robustly (sorted) ----
set "FIRST_PNG="
for /f "usebackq delims=" %%F in (`dir /b /a-d "!PNG_DIR!\*.png" ^| sort`) do (
    set "FIRST_PNG=%%F"
    goto _fp_done
)
:_fp_done
if not defined FIRST_PNG (
    echo [ERR] No PNG files in !PNG_DIR!
    pause
    exit /b 3
)

rem ---- Auto Scale Wizard (no questions) ----
if not exist "!PNG_DIR!\!FIRST_PNG!.scale.csv" (
    echo [INFO] No SCALE for "!FIRST_PNG!" -> starting Scale Wizard...
    set "GUI_LOG=%LOG_DIR%\gui_scale_last.log"
    %PY% "%TOOL_DIR%\annot_gui_custom.py" --root "%ROOT%" --images "!PNG_DIR!" --start-from "!FIRST_PNG!" --scale-wizard 1> "!GUI_LOG!" 2>&1
    if not exist "!PNG_DIR!\!FIRST_PNG!.scale.csv" (
        echo [ERR] Scale file still missing after wizard.
        echo See "!GUI_LOG!" below:
        type "!GUI_LOG!" | more
        pause
    )
)

rem ---- Launch custom GUI (always) ----
set "GUI_LOG=%LOG_DIR%\gui_run_last.log"
%PY% "%TOOL_DIR%\annot_gui_custom.py" --root "%ROOT%" --images "!PNG_DIR!" 1> "!GUI_LOG!" 2>&1
set "RC=%ERRORLEVEL%"
if not "!RC!"=="0" (
    echo [ERR] GUI exited with code !RC!. See "!GUI_LOG!" below:
    type "!GUI_LOG!" | more
    pause
)

exit /b 0
'@
PS D:\GM\tools\2_Landmarking_v1.0> $annotContent | Set-Content -Path "1_ANNOTATOR.bat" -Encoding OEM
PS D:\GM\tools\2_Landmarking_v1.0> # 5) Переписываем 2_TRAIN-INFER_HRNet.bat, чтобы он тоже вызывал init_structure.py + rebuild_localities_status.py
PS D:\GM\tools\2_Landmarking_v1.0> $trainerBatContent = @'
@echo off
setlocal EnableExtensions EnableDelayedExpansion
chcp 65001 >nul

rem ---- Paths ----
set "HERE=%~dp0"
for %%I in ("%HERE%\..\..") do set "ROOT=%%~fI"
set "TOOL_DIR=%ROOT%\tools\2_Landmarking_v1.0"
set "LOG_DIR=%TOOL_DIR%\logs"
if not exist "%LOG_DIR%" mkdir "%LOG_DIR%" >nul 2>&1

rem ---- Localities base picker (Windows dialog) ----
powershell -NoProfile -ExecutionPolicy Bypass -File "%TOOL_DIR%\scripts\choose_localities.ps1" -Silent
if errorlevel 1 (
    echo [WARN] Localities base picker failed or was cancelled.>>"%LOG_DIR%\trainer_last.log"
    echo [WARN] Localities base picker failed or was cancelled.
)

rem ---- Resolve PHOTOS_DIR from cfg\last_base.txt ----
set "CFG_DIR=%TOOL_DIR%\cfg"
set "LAST_BASE=%CFG_DIR%\last_base.txt"
set "PHOTOS_DIR="
if exist "%LAST_BASE%" (
    set /p PHOTOS_DIR=<"%LAST_BASE%"
)
if not defined PHOTOS_DIR (
    echo [ERR] Localities base path not found in cfg\last_base.txt.>>"%LOG_DIR%\trainer_last.log"
    echo [ERR] Localities base path not found in cfg\last_base.txt.
    pause
    exit /b 1
)

rem ---- Python resolver ----
set "PY=%TOOL_DIR%\.venv_lm\Scripts\python.exe"
if not exist "%PY%" (
    where py >nul 2>&1 && (set "PY=py -3")
)
if /I "%PY%"=="py -3" (
    py -3 -c "import sys" >nul 2>&1 || set "PY="
)
if not defined PY (
    where python >nul 2>&1 && (set "PY=python")
)
if not defined PY (
    echo [ERR] Landmarking environment not found.>>"%LOG_DIR%\trainer_last.log"
    echo [ERR] Landmarking environment not found.
    echo Run 0_INSTALL_ENV.ps1.
    pause
    exit /b 1
)

rem ---- Init structure + localities registry ----
%PY% "%TOOL_DIR%\scripts\init_structure.py"
if errorlevel 1 (
    echo [ERR] init_structure.py failed.>>"%LOG_DIR%\trainer_last.log"
    echo [ERR] init_structure.py failed.
    pause
    exit /b 1
)

%PY% "%TOOL_DIR%\scripts\rebuild_localities_status.py"
if errorlevel 1 (
    echo [ERR] rebuild_localities_status.py failed.>>"%LOG_DIR%\trainer_last.log"
    echo [ERR] rebuild_localities_status.py failed.
    pause
    exit /b 1
)

title == GM Landmarking: HRNet Trainer v1.0 ==
echo == GM Landmarking: HRNet Trainer v1.0 ==

rem ---- Launch trainer menu (Python) ----
%PY% "%TOOL_DIR%\scripts\trainer_menu.py" --root "%ROOT%"
set "RC=%ERRORLEVEL%"
if not "%RC%"=="0" (
    echo [ERR] Trainer menu exited with code %RC%.>>"%LOG_DIR%\trainer_last.log"
    echo [ERR] Trainer menu exited with code %RC%.
    pause
)

endlocal
exit /b 0
'@
PS D:\GM\tools\2_Landmarking_v1.0> $trainerBatContent | Set-Content -Path "2_TRAIN-INFER_HRNet.bat" -Encoding OEM
PS D:\GM\tools\2_Landmarking_v1.0> # 6) Смотрим, что изменилось, и коммитим
PS D:\GM\tools\2_Landmarking_v1.0> git status

PS D:\GM\tools\2_Landmarking_v1.0> git add -A

PS D:\GM\tools\2_Landmarking_v1.0> git commit -m "feat: add init_structure and hook it into annotator/trainer"

PS D:\GM\tools\2_Landmarking_v1.0> # 7) ОБЯЗАТЕЛЬНЫЙ push + проверка
PS D:\GM\tools\2_Landmarking_v1.0> git push origin main

PS D:\GM\tools\2_Landmarking_v1.0> git ls-remote --heads origin

PS D:\GM\tools\2_Landmarking_v1.0> # 8) Стоп лога
PS D:\GM\tools\2_Landmarking_v1.0> Stop-Transcript
**********************
Конец записи протокола Windows PowerShell
Время окончания: 20251114232150
**********************
