**********************
Начало записи сценария Windows PowerShell
Время начала: 20251116153402
Имя пользователя: BERS\artae
Запуск от имени пользователя: BERS\artae
Имя конфигурации: 
Компьютер: BERS (Microsoft Windows NT 10.0.26200.0)
Ведущее приложение: C:\WINDOWS\System32\WindowsPowerShell\v1.0\powershell.exe
ИД процесса: 10784
PSVersion: 5.1.26100.7019
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.26100.7019
BuildVersion: 10.0.26100.7019
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
Транскрибирование запущено, выходной файл logs\ps_fix_numpy_xtcocotools_20251116_153402.log
PS D:\GM\tools\2_Landmarking_v1.0> Write-Host "=== FIX NumPy <-> xtcocotools binary incompatibility in .venv_lm ==="
=== FIX NumPy <-> xtcocotools binary incompatibility in .venv_lm ===
PS D:\GM\tools\2_Landmarking_v1.0> $py = ".\.venv_lm\Scripts\python.exe"
PS D:\GM\tools\2_Landmarking_v1.0> if (!(Test-Path $py)) {
    Write-Host "[ERR] .venv_lm\\Scripts\\python.exe not found. Cannot proceed."
} else {
    Write-Host "[INFO] Using Python:" $py

    Write-Host "`n[INFO] Versions BEFORE fix:"
    $showBefore = @'
import importlib

def show(name):
    try:
        m = importlib.import_module(name)
        ver = getattr(m, "__version__", "?")
        print(f"{name}: {ver}")
    except Exception as e:
        print(f"{name}: FAIL ({e!r})")

for pkg in ("numpy", "torch", "mmengine", "mmcv", "mmpose", "xtcocotools"):
    show(pkg)
'@
    $showBeforePath = "scripts\\_show_stack_before_numpy_xtc_fix.py"
    $showBefore | Set-Content $showBeforePath -Encoding UTF8
    & $py $showBeforePath

    # --- 1. Принудительно ставим NumPy 1.x ---
    Write-Host "`n[INFO] Force reinstall NumPy < 2.0.0 ..."
    & $py -m pip install "numpy<2.0.0" --force-reinstall -U

    # --- 2. Полностью сносим xtcocotools ---
    Write-Host "`n[INFO] Uninstall xtcocotools ..."
    & $py -m pip uninstall -y xtcocotools

    # --- 3. Собираем xtcocotools без build isolation, чтобы он увидел текущую NumPy ---
    Write-Host "`n[INFO] Install xtcocotools with --no-build-isolation (rebuild against current NumPy) ..."
    & $py -m pip install --no-build-isolation --force-reinstall "xtcocotools>=0.1.0"

    # --- 4. Смотрим версии ПОСЛЕ ---
    Write-Host "`n[INFO] Versions AFTER fix:"
    $showAfter = @'
import importlib

def show(name):
    try:
        m = importlib.import_module(name)
        ver = getattr(m, "__version__", "?")
        print(f"{name}: {ver}")
    except Exception as e:
        print(f"{name}: FAIL ({e!r})")

for pkg in ("numpy", "torch", "mmengine", "mmcv", "mmpose", "xtcocotools"):
    show(pkg)
'@
    $showAfterPath = "scripts\\_show_stack_after_numpy_xtc_fix.py"
    $showAfter | Set-Content $showAfterPath -Encoding UTF8
    & $py $showAfterPath

    # --- 5. Проверка: можем ли теперь импортировать HRNet из MMPose ---
    Write-Host "`n[INFO] FINAL check: MMPose HRNet import ..."
    $checkScript = @'
import numpy, traceback

print("=== FINAL MMPose HRNet import check ===")
print("numpy version:", numpy.__version__)
try:
    from mmpose.models.backbones import HRNet as MMPoseHRNet
    print("MMPoseHRNet imported OK:", MMPoseHRNet)
except Exception as e:
    print("IMPORT_ERROR:", repr(e))
    traceback.print_exc()
'@
    $checkPath = "scripts\\_check_mmpose_hrnet_import_final2.py"
    $checkScript | Set-Content $checkPath -Encoding UTF8
    & $py $checkPath
}
[INFO] Using Python: .\.venv_lm\Scripts\python.exe

[INFO] Versions BEFORE fix:


[INFO] Force reinstall NumPy < 2.0.0 ...


[INFO] Uninstall xtcocotools ...


[INFO] Install xtcocotools with --no-build-isolation (rebuild against current NumPy) ...


[INFO] Versions AFTER fix:


[INFO] FINAL check: MMPose HRNet import ...

PS D:\GM\tools\2_Landmarking_v1.0> Write-Host "`n=== FIX step finished ==="

=== FIX step finished ===
PS D:\GM\tools\2_Landmarking_v1.0> Stop-Transcript
**********************
Конец записи протокола Windows PowerShell
Время окончания: 20251116153432
**********************
